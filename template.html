#if($products.size() > 0)
#set($imgCount = 0)
#set($prdCount = 1)
<style>
    #$divId .nosto_tip {
      display:none;
    }

    #$divId {
      max-width: 1300px;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      box-sizing: border-box;
      margin: 0 auto;
    }

    #$divId .nosto-container{
      display: flex;
      flex-direction: column;
    }

    #$divId .nosto-list{
      display: flex;
    }

    #$divId .nosto-item{
      flex-basis: 24%;
    }

    #$divId .nosto-image-container{
      width: 100%;
      height: 200px;
      display: block;
      position: relative;
    }
</style>
<h4 class="nosto-header">$!title</h4>
<div class="nosto-container">
        <ul class="nosto-list">
            #foreach($product in $products)
            <li class="nosto-item nosto-list-item">
                <style>
                    #if($!product.alternateImageUrls && $!product.alternateImageUrls.size() > 0)
                      #$divId .img-$imgCount:before, #$divId .img-$imgCount:after {
                        content: "";
                        position: absolute;
                        background-position: center center;
                        top: 0px;
                        right: 0px;
                        bottom: 0px;
                        left: 0px;
                        opacity: 1;
                        z-index: 1;
                      }
                      #$divId .img-$imgCount:before {
                        background-image: url('$!product.thumb(8)');
                        background-size: contain !important;
                        background-repeat: no-repeat;
                        transition: opacity 0.3s;
                        z-index: 2;
                      }
                      #$divId .img-$imgCount:after{
                        background-image: url('$!product.alternateImageUrls[0]');
                        background-size: contain !important;
                        background-repeat: no-repeat;
                        opacity: 0;
                        transition: opacity 0.3s;
                      }
                      #$divId .img-$imgCount:hover:before{
                        opacity: 0;
                      }
                      #$divId .img-$imgCount:hover:after{
                        opacity: 1;
                      }
                    #else
                      #$divId .img-$imgCount{
                        background-image: url('$!product.thumb(8)');
                        background-position: center center;
                        background-repeat: no-repeat;
                        background-size: contain !important;
                      }
                    #end
                </style>
                <a href="#if($prdCount == 1) # #else $!product.url #end" alt="$!product.name">
                    <div class="nosto-image-container img-$imgCount"></div>
                </a>
            </li>
            #if($prdCount == $products.size())
              <li class="nosto-item nosto-list-price">
                  <span class="nosto-total">Total Price: <span class="nosto-total-price">€0</span></span>
                  <div class="nosto-cta">
                      <button type="submit" title="Add To Basket" class="">Add To Basket</button>
                  </div>
              </li>
            #else
              <li class="nosto-list-plus">
                  <span>+</span>
              </li>
            #end
            #set($imgCount = $imgCount + 1)
            #set($prdCount = $prdCount + 1)
            #end
        </ul>
        <div class="nosto-products">
            #foreach($product in $products)
            <div class="nosto-product-info">
                <div class="nosto-product-desc-block">
                    <input name="nosto-checkbox" hiddenname="check$!product.productId" checked type="checkbox" class="nosto-checkbox" value="$!product.price">
                    <a href="$!product.url" class="nosto-product-name">$!product.name.truncate(70)</a>
                    #if($product.discounted)
                      <a href="$!product.url" class="nosto-product-price">
                      <span class="nosto-oldprice">$!product.listPrice</span>
                      <span class="nosto-price nosto-newprice">$!product.price</span>
                      </a>
                    #else
                      <a href="$!product.url" class="nosto-price">$!product.price</a>
                    #end
                </div>
            </div>
            #end
    </form>
    </div>
</div>
<script type="text/javascript">
    var doc = _targetWindow.document;
    var j = _targetWindow.jQuery;

    function findTotal() {
        var totalprice = 0;
        j('input[type="checkbox"]:checked').each(function(){
            var price = j(this).val();
            var actualPrice = Number(price.replace(/[^0-9\.]+/g,""));
            var decimalPrice = parseFloat(actualPrice);
            totalprice = totalprice + parseFloat(decimalPrice) ;
        });
        var price = parseFloat(totalprice).toFixed(2);
        j('.nosto-total-price').html(price + "€");
    };

    j('.nosto-checkbox').on('change', function(e) {
        var totalprice = 0;
        findTotal();
    });

    function mapProduct() {
        var nostoProd = {};
        var nostoProdArr = [].slice.call(doc.querySelector('.nosto_product').children);
        nostoProdArr.forEach(function(attr) {
            var attribute = attr.innerText;
            var name = attr.className;
            nostoProd[name] = attribute;
        });
            console.log('product', nostoProd);
        return nostoProd;
    };

    function pushProd(products) {
        var nostoNodeItems = doc.querySelectorAll('#$divId .nosto-list-item');
        var nostoArrayItems = Array.prototype.slice.call(nostoNodeItems);
        var nostoItem = nostoArrayItems[0];
        var nostoItemStyle = nostoItem.children[0];
        var nostoItemLink = nostoItem.children[1];
        var nostoBgImg = `
            #$divId .img-0 {
                background-image: url('${products.image_url}');
                background-position: center center;
                background-repeat: no-repeat;
                background-size: contain !important;
            } `;
                nostoItemStyle.innerHTML = nostoBgImg;
        nostoItemLink.attributes[1].alt = products.name;
        nostoItemLink.attributes[1].textContent = products.name;

        // product name
        var nostoNodeName = doc.querySelectorAll('#$divId .nosto-product-name');
        var nostoArrayName = Array.prototype.slice.call(nostoNodeName);
        nostoArrayName[0].innerText = products.name;

        // value object
        var nostoNodeValue = doc.querySelectorAll('#$divId .nosto-checkbox');
        var nostoArrayValue = Array.prototype.slice.call(nostoNodeValue);
        nostoArrayValue[0].value = `€${products.price}`;

        // product price
        var nostoNodePrice = doc.querySelectorAll('#$divId .nosto-price');
        var nostoArrayPrice = Array.prototype.slice.call(nostoNodePrice);
        // do the same for discounted prods
        var nostoNodeListPrice = doc.querySelectorAll('#$divId .nosto-oldprice');
        var nostoArrayListPrice = Array.prototype.slice.call(nostoNodeListPrice);
        if(products.price != products.list_price) {
            nostoArrayListPrice[0].innerText = `${products.list_price}€`;
        } else {
            nostoArrayListPrice[0].innerText = ``;
        }
        // fix price decimals with the 0 if is rounded
        var priceSplitted = products.price.toString().split('.');
        if(products.price.includes('.')) {
            priceSplitted[1].length === 1
            ? nostoArrayPrice[0].innerText = `${products.price}0€`
            : nostoArrayPrice[0].innerText = `${products.price}€`
        }
        else if (products.price === '') {
            nostoArrayPrice[0].innerText = ``
        } else {
            nostoArrayPrice[0].innerText = `${products.price}.00€`
        }
    };

    _targetWindow.jQuery(doc).ready(function() {
        mapProduct();
        pushProd(mapProduct());
        findTotal();
    });
</script>
#end
